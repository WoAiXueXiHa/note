# 1. 理解文件

文件 = 文件属性 + 文件内容

文件系统包括了加载到内存中的文件和保存在磁盘中的文件两大类

重点谈加载到内存中的文件：

根据冯诺依曼体系->文件从磁盘中加载到内存缓冲区中，等待CPU执行，这个过程由进程进行文件操作

而在代码中的体现：

![image-20251227210437503](https://gitee.com/binary-whispers/pic/raw/master///20251227210441092.png)

**研究打开的文件，本质是研究进程和文件之间的关系**

# 2. 系统调用接口

![image-20251227210845839](https://gitee.com/binary-whispers/pic/raw/master///20251227210848120.png)

```cpp
#include <sys/types.h>
#include <fcntl.h>
#include <sys/stat.h>

int open(const char* pathname, int flags, mode_t mode);
```

> * `pathname`：文件路径名
> * `flags`：标志位，位图->32个bit位，有几个常见的宏
>   * `O_RDONLY`：只读
>   * `O_WRONLY`：只写
>   * `O_RWDWR`：读写
>   * `O_CREAT`：新建
>   * `O_APPEND`：追加
>   * `O_TRUNC`：清空
> * `mode`：设置文件权限，设置的权限要`&(~umask)`

```cpp
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

int main(){
  open("log.txt",O_TRUNC | O_RDWR, 666); // 清空+读写
  return 0;
}

```

```bash
[vect@VM-0-11-centos file]$ cat log.txt
hghhssladj
sajldjas
asld
[vect@VM-0-11-centos file]$ gcc open.c
[vect@VM-0-11-centos file]$ ./a.out 
[vect@VM-0-11-centos file]$ cat log.txt 
[vect@VM-0-11-centos file]$ 
```

写操作：![image-20251227212954626](https://gitee.com/binary-whispers/pic/raw/master///20251227212957228.png)

读操作：![image-20251227213029988](https://gitee.com/binary-whispers/pic/raw/master///20251227213031627.png)

关闭操作：![](https://gitee.com/binary-whispers/pic/raw/master///20251227213056842.png)

C的文件操作函数都是基于这四个系统调用接口封装的

# 3. 理解fd

文件描述符->本质是**数组索引**

文件加载到内存中需要管理->需要管理文件属性和文件内容->怎么管理？->先描述，再组织！

![image-20251227213805263](https://gitee.com/binary-whispers/pic/raw/master///20251227213807822.png)

**fd分配原则：** 进程启动默认打开三个文件流：stdin stdout stderr 索引依次为1 2 3，新打开的文件按照未分配最小的索引开始，依次按照文件打开顺序递增分配

这里涉及到重定向：

![image-20251227214434901](https://gitee.com/binary-whispers/pic/raw/master///20251227214441338.png)

使用`dup2`完成重定向

```cpp
#include <unistd.h>
int dup2(int oldfd, int newfd);
```

![image-20251227215455071](https://gitee.com/binary-whispers/pic/raw/master///20251227215456967.png)

这句话的意思是`newfd`是`oldfd`的拷贝，所以重定向到`newfd`

![image-20251227215740506](https://gitee.com/binary-whispers/pic/raw/master///20251227215742261.png)



```cpp
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>

int main(){
  int fd1 = open("log1.txt",O_CREAT | O_RDWR,0666);
  int fd2 = open("log2.txt",O_RDWR | O_CREAT,0666);
  int fd3 = open("log3.txt",O_RDWR | O_CREAT,0666);

  dup2(fd1,1);
  printf("%d\n",fd1);
  printf("%d\n",fd2);
  printf("%d\n",fd3);

}

```

```bash
[vect@VM-0-11-centos file]$ gcc dup2.c 
[vect@VM-0-11-centos file]$ ls
a.out  dup2.c  log.txt  open.c  proc.c
[vect@VM-0-11-centos file]$ ./a.out 
[vect@VM-0-11-centos file]$ ls
a.out  dup2.c  log1.txt  log2.txt  log3.txt  log.txt  open.c  proc.c
[vect@VM-0-11-centos file]$ cat log1.txt 
3
4
5

```

本来应该输出到显示器，但是重定向输出到文件里了